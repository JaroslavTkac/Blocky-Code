<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <title>StickJS</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/jquery.roundslider/1.3/roundslider.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/css/bootstrap-slider.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="assets/css/styles.css">

    <!-- JavaScript Includes -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="assets/js/jquery.knob.js"></script>

    <!-- jQuery File Upload Dependencies -->
    <script src="assets/js/jquery.ui.widget.js"></script>
    <script src="assets/js/jquery.iframe-transport.js"></script>
    <script src="assets/js/jquery.fileupload.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/bootstrap-slider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.roundslider/1.3/roundslider.min.js"></script>



   

</head>
<body>
    <!-- .navbar-fixed-top, or .navbar-fixed-bottom can be added to keep the nav bar fixed on the screen -->
    <nav class="navbar navbar-default navbar-static-top" data-spy="affix" data-offset-top="120" style="margin-bottom: 0">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <!-- Button that toggles the navbar on and off on small screens -->
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <!-- Draws 3 bars in navbar button when in small mode -->
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- You'll have to add padding in your image on the top and right of a few pixels (CSS Styling will break the navbar) -->
                <a class="pull-left" href="../index.html"><img style="height: 50px" src="assets/img/design/StickJSlogo.png"></a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <!--class="active"-->
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="../#creator-info">About</a></li>
                        <li><a href="#">How To</a></li>
                    </ul>
                    <form class="navbar-right my">
                        <a href="#" class=""></a>
                    </form>
                </div>
        </div>
    </nav>


     <!-- How to modal -->
     <div class="modal fade" id="how-to-modal" role="dialog" data-keyboard="false">
         <div class="modal-dialog" >
             <div class="modal-content" >
                 <div align="center" class="modal-header">
                     <button type="button" class="close" data-dismiss="modal">&times;</button>
                     <h4 class="modal-title" style="alignment: center">How to use StickJS</h4>
                 </div>
                 <div class="modal-body" >
                     <h2 align="center">Upload</h2>
                     <hr class="update-hr">
                     <p>By clicking upload button, you can upload these types of files to server.</p>
                     <ul>
                         <li>mp3</li>
                         <li>obj</li>
                         <li>png</li>
                         <li>jpg</li>
                     </ul>
                     <p><i>StickJS only supports .obj files, that are UV unwrapped (have texture coordinates).</i></p>
                     <h2 align="center">Editor</h2>
                     <hr class="update-hr">
                     <p>There you can modify shapes and save them for following exporting to main scene.</p>
                     <p><i>Color, Texture, Opacity and Shape rotation directly have effect on shape before saving. However by clicking on tab Lightning
                         you only affecting shapes that are in editor window.</i></p>
                 </div>
             </div>
         </div>
     </div>

    <div class="container-fluid" style="background: #e3eef4">
        <div class="row">
            <!-- Main Scene & Importer -->
            <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12" style="padding: 0 0 0 0">
                <!-- WEB GL Canvas area -->
                <canvas id="Scene" style="border: 3pt black solid"></canvas>

                <!-- Add shape name modal -->
                <div class="modal fade" id="add-name-modal" role="dialog" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog" >
                        <div class="modal-content" >
                            <div align="center" class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title" style="alignment: center">Enter Object Name</h4>
                            </div>
                            <div align="center" class="modal-body" >
                                <form>
                                    <div id="add-shape-name-form" class="form-group ">
                                        <label for="usr-shape-name">Name</label>
                                        <input type="text" class="form-control" id="usr-shape-name">
                                        <p id="error-explanation"></p>
                                    </div>
                                    <button class="btn btn-primary" id="add-shape-name">Submit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload and selection navigation bar -->
                <div >
                    <nav class="navbar navbar-default navbar-static-top" style="margin: 0 0 0 0;">
                        <div class="container-fluid">
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-3" aria-expanded="false">
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="#"><img style="margin-top: -28%; height: 50px" src="assets/img/design/SelectIcon.png"></a>
                            </div>
                            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-3">
                                <ul class="nav navbar-nav">
                                    <li class="dropdown">
                                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Select<span class="caret"></span></a>
                                        <ul class="dropdown-menu" id="select-dropdown-value">
                                            <li><a href="#">Shapes</a></li>
                                            <li><a href="#">Music</a></li>
                                            <li><a href="#">Textures</a></li>
                                        </ul>
                                    </li>
                                </ul>
                                <ul class="navbar-right">
                                    <form id="upload" method="post" action="upload.php" style="padding-top: 10%" >
                                        <label class="btn btn-primary"><span class="glyphicon glyphicon-save-file"></span> Upload
                                            <input type="file" name="upl" accept="image/png/jpg/obj/mp3" style="display: none;">
                                        </label>
                                    </form>
                                </ul>
                            </div>
                        </div>
                    </nav>

                    <div id="selectable-shapes">
                        <div class="row" id="selectable-shapes-row">
                            <div class="col-lg3 col-md-4 col-sm-4 col-xs-6" align="center">
                                <a href="#" class="thumbnail">
                                    <canvas class="preview-scene shape" id="shapes/cube.json" ></canvas>
                                    <a href="#" class="btn btn-md overlay-btn disabled"><span class="glyphicon glyphicon-trash"></span></a>
                                </a>
                            </div>
                            <div class="col-lg3 col-md-4 col-sm-4 col-xs-6" align="center">
                                <a href="#" class="thumbnail">
                                    <canvas class="preview-scene shape" id="shapes/sphere.json" ></canvas>
                                    <a href="#" class="btn btn-md overlay-btn disabled"><span class="glyphicon glyphicon-trash"></span></a>
                                </a>
                            </div>
                            <div class="col-lg3 col-md-4 col-sm-4 col-xs-6" align="center">
                                <a href="#" class="thumbnail">
                                    <canvas class="preview-scene shape" id="shapes/cone.json" ></canvas>
                                    <a href="#" class="btn btn-md overlay-btn disabled"><span class="glyphicon glyphicon-trash"></span></a>
                                </a>
                            </div>
                            <div class="col-lg3 col-md-4 col-sm-4 col-xs-6" align="center">
                                <a href="#" class="thumbnail">
                                    <canvas class="preview-scene shape" id="shapes/cylinder.json" ></canvas>
                                    <a href="#" class="btn btn-md overlay-btn disabled"><span class="glyphicon glyphicon-trash"></span></a>
                                </a>
                            </div>
                            <div class="col-lg3 col-md-4 col-sm-4 col-xs-6" align="center">
                                <a href="#" class="thumbnail">
                                    <canvas class="preview-scene shape" id="shapes/simpleSphere.json" ></canvas>
                                    <a href="#" class="btn btn-md overlay-btn disabled"><span class="glyphicon glyphicon-trash"></span></a>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div id="selectable-music" style="display: none;">
                        <div class="row" id="selectable-music-row">

                        </div>
                    </div>

                    <div id="selectable-textures" style="display: none;">
                        <div class="row" id="selectable-textures-row">

                        </div>
                    </div>
                </div>
            </div>

            <!-- Nav Bar Editor/Logic/Sound -->
            <div class="col-lg-7 col-md-7 col-sm-12 col-xs-12" id="editor-logic-sound" style="padding: 0 0 0 0">
                <nav class="navbar navbar-default navbar-static-top" style="margin-bottom: 0">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-2" aria-expanded="false">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <a class="navbar-brand" href="#"><img style="margin-top: -27%; height: 45px" src="assets/img/design/SettingsIcon.png"></a>
                        </div>
                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
                            <ul class="nav navbar-nav editor-navbar">
                                <li class="active"><a href="#">Editor</a></li>
                                <li><a href="#">Logic</a></li>
                                <li><a href="#">Sound</a></li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <!-- Editor/Logic/Sound -->
                <div class="container-fluid col-lg-12 col-md-12 col-sm-12 col-xs-12" id="editor-area">
                    <!-- EDITOR -->
                    
                    <!-- LOGIC -->
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="code-blocks-container">


                        <svg id="code-logic-scene"
                             xmlns:svg="http://www.w3.org/2000/svg"
                             xmlns="http://www.w3.org/2000/svg"
                             version="1.1"
                             width="100%" height="500">

                            <g class="draggable nonjoinable"
                               transform="matrix(1 0 0 1 0 0)"
                               onmousedown="selectElement(evt)">

                                <rect
                                      x="30" y="30"
                                      width="170" height="40"
                                      fill="blue" stroke="black" stroke-width="2">
                                </rect>
                                <text class="basic-text-over-svg" x="38" y="55">
                                    Coordinate X:
                                </text>
                                <foreignObject x="140" y="32"
                                               width="40" height="40">
                                    <form>
                                        <input class="code-input" title="Coordinate X:" type="text" value="0"/>
                                    </form>
                                </foreignObject>
                                <text class="code-id"
                                      x="38" y="55">modify X</text>
                                <text class="mktime"
                                      x="38" y="55">blue</text>
                                <text class="myChild"
                                      x="38" y="55"></text>
                                <text class="myFather"
                                      x="38" y="55"></text>
                            </g>

                            <g class="draggable joinable"
                               transform="matrix(1 0 0 1 0 0)"
                               onmousedown="selectElement(evt)">

                                <rect class="draggable"
                                      x="360" y="50"
                                      width="170" height="40"
                                      fill="green" stroke="black" stroke-width="2">
                                </rect>

                                <text class="basic-text-over-svg"
                                        x="370" y="70">
                                    Shape:
                                </text>
                                <foreignObject x="430" y="51"
                                               width="90" height="40">
                                    <select class="code-selection" title="Shape selection">
                                        <option value="volvo">Volvo</option>
                                        <option value="saab">Saab</option>
                                        <option value="opel">Opel</option>
                                        <option value="audi">Audi</option>
                                    </select>
                                </foreignObject>
                                <text class="code-id"
                                      x="370" y="70">select shape</text>
                                <text class="mktime"
                                      x="370" y="70">green</text>
                                <text class="myChild"
                                      x="370" y="70"></text>
                                <text class="myFather"
                                      x="370" y="70"></text>

                            </g>


                            <g class="draggable joinable"
                               transform="matrix(1 0 0 1 0 0)"
                               onmousedown="selectElement(evt)">
                                <path d="M 100 200 L 300 200 C 325.954 191.355 311.556 145.657 300 149.448
                                L 200 148.965 L 100 149.449 C 87.216 144.931 74.87 191.464 100 200 Z" fill="orange" stroke="black" stroke-width="2"></path>


                                <text class="code-id"
                                      x="150" y="170">mod y</text>
                                <text class="mktime"
                                      x="150" y="170">orange</text>
                                <text class="myChild"
                                      x="150" y="170"></text>
                                <text class="myFather"
                                      x="150" y="170"></text>
                            </g>


                            <g class="draggable joinable"
                               transform="matrix(1 0 0 1 0 0)"
                               onmousedown="selectElement(evt)">
                                <path d="M 100 300 L 200.264 299.649 C 220.44 297.803 217.229 251.07 200 253.136
                                 L 100 253.136 C 74.631 264.692 89.202 304.561 100 300 Z" fill="red" stroke="black" stroke-width="2"></path>

                                <text class="code-id"
                                      x="105" y="280">2</text>
                                <text class="mktime"
                                      x="105" y="280">red</text>
                                <text class="myChild"
                                      x="105" y="280"></text>
                                <text class="myFather"
                                      x="105" y="280"></text>

                            </g>

                            <g class="draggable joinable"
                               transform="matrix(1 0 0 1 90 150)"
                               onmousedown="selectElement(evt)">
                                <path d="M 100 300 L 200.264 299.649 C 220.44 297.803 217.229 251.07 200 253.136
                                 L 100 253.136 C 74.631 264.692 89.202 304.561 100 300 Z" fill="yellow" stroke="black" stroke-width="2"></path>

                                <text class="code-id"
                                      x="105" y="280">2</text>
                                <text class="mktime"
                                      x="105" y="280">yellow</text>
                                <text class="myChild"
                                      x="105" y="280"></text>
                                <text class="myFather"
                                      x="105" y="280"></text>

                            </g>

                            <g class="draggable joinable"
                               transform="matrix(1 0 0 1 190 -30)"
                               onmousedown="selectElement(evt)">
                                <path d="M 100 300 L 200.264 299.649 C 220.44 297.803 217.229 251.07 200 253.136
                                 L 100 253.136 C 74.631 264.692 89.202 304.561 100 300 Z" fill="brown" stroke="black" stroke-width="2"></path>

                                <text class="code-id"
                                      x="105" y="280">2</text>
                                <text class="mktime"
                                      x="105" y="280">brown</text>
                                <text class="myChild"
                                      x="105" y="280"></text>
                                <text class="myFather"
                                      x="105" y="280"></text>

                            </g>

                            <g class="draggable joinable"
                               transform="matrix(1 0 0 1 290 120)"
                               onmousedown="selectElement(evt)">
                                <path d="M 100 300 L 200.264 299.649 C 220.44 297.803 217.229 251.07 200 253.136
                                 L 100 253.136 C 74.631 264.692 89.202 304.561 100 300 Z" fill="white" stroke="black" stroke-width="2"></path>

                                <text class="code-id"
                                      x="105" y="280">2</text>
                                <text class="mktime"
                                      x="105" y="280">white</text>
                                <text class="myChild"
                                      x="105" y="280"></text>
                                <text class="myFather"
                                      x="105" y="280"></text>
                            </g>

                            <g class="nonjoinable trash-bin" transform="matrix(1 0 0 1 0 360)" stroke="black" stroke-width="2">
                                <path transform="scale(1.0)" d="M50,32.319c5.584,0,11.004,0.191,16.11,0.568c4.538,0.335,8.688,0.807,12.335,1.403c0.187,0.031,0.371,0.061,0.555,0.092
                                l-4.644,56.935c-5.156,0.662-10.919,1.095-17.117,1.284H42.793c-6.229-0.189-11.992-0.622-17.148-1.284L21,34.382
                                c0.184-0.031,0.369-0.062,0.556-0.092c3.645-0.596,7.794-1.067,12.333-1.403C38.994,32.51,44.415,32.319,50,32.319 M49.998,53.771
                                l-9.977-9.96c-1.075-1.072-2.503-1.663-4.022-1.663s-2.947,0.59-4.022,1.663c-1.075,1.074-1.667,2.501-1.667,4.02
                                c0,1.517,0.592,2.943,1.667,4.016l9.974,9.957l-9.974,9.956c-1.075,1.073-1.667,2.5-1.667,4.017c0,1.518,0.592,2.944,1.667,4.019
                                c1.075,1.072,2.504,1.663,4.023,1.663c1.518,0,2.946-0.591,4.021-1.663l9.976-9.958l9.979,9.958
                                c1.076,1.072,2.505,1.663,4.024,1.663s2.947-0.591,4.021-1.663c1.076-1.074,1.668-2.501,1.668-4.019
                                c0-1.517-0.592-2.943-1.668-4.018l-9.975-9.955l9.975-9.957c1.075-1.072,1.668-2.499,1.668-4.016c0-1.518-0.592-2.946-1.668-4.02
                                c-1.074-1.072-2.503-1.663-4.022-1.663s-2.948,0.59-4.022,1.663L49.998,53.771 M50,31.319c-5.645,0-11.119,0.197-16.185,0.571
                                c-4.522,0.334-8.721,0.809-12.42,1.413c-0.498,0.081-0.986,0.165-1.465,0.252l4.785,58.648c4.94,0.666,10.983,1.183,18.048,1.398
                                h14.476c7.063-0.216,13.107-0.732,18.048-1.398l4.783-58.648c-0.479-0.087-0.966-0.171-1.465-0.252
                                c-3.699-0.604-7.896-1.079-12.422-1.413C61.117,31.516,55.645,31.319,50,31.319L50,31.319z M49.998,55.185l10.685-10.666
                                c0.916-0.914,2.116-1.371,3.316-1.371s2.4,0.457,3.316,1.371c1.832,1.829,1.832,4.792,0,6.62L56.632,61.804l10.684,10.663
                                c1.832,1.829,1.832,4.791,0,6.62c-0.915,0.914-2.115,1.371-3.314,1.371c-1.201,0-2.401-0.457-3.318-1.371L49.998,68.424
                                L39.315,79.087C38.399,80.001,37.2,80.458,36,80.458c-1.201,0-2.401-0.457-3.317-1.371c-1.831-1.829-1.831-4.791,0-6.62
                                l10.683-10.663L32.684,51.139c-1.831-1.827-1.831-4.791,0-6.62c0.916-0.914,2.115-1.371,3.315-1.371c1.2,0,2.4,0.457,3.316,1.371
                                L49.998,55.185L49.998,55.185z">
                                </path>
                                <text class="code-id"
                                      x="50" y="50">TRASHBIN</text>
                                <text class="mktime"
                                      x="50" y="50">trashbin</text>
                                <text class="myChild"
                                      x="50" y="50"></text>
                                <text class="myFather"
                                      x="50" y="50"></text>
                            </g>

                        </svg>
                        <button id="push-code" type="button">Save Code</button>










                    </div><!-- END LOGIC -->
                </div><!-- Editor area closing tag -->
            </div><!-- Nav Bar Editor area closing tag -->
        </div>
    </div>
</body>
<script>

    $(document).ready(function() {


        $(window).keydown(function(event){
            if(event.keyCode === 13) {
                event.preventDefault();
                return false;
            }
        });
        setTimeout(function () {
            var element = "<g class=\"draggable joinable\"\n" +
                "transform=\"matrix(1 0 0 1 450 80)\"\n" +
                "onmousedown=\"selectElement(evt)\">" +
                "<path d=\"M 100 300 L 200.264 299.649 C 220.44 297.803 217.229 251.07 200 253.136" +
                "L 100 253.136 C 74.631 264.692 89.202 304.561 100 300 Z\" fill=\"black\" stroke=\"black\" stroke-width=\"2\"></path>" +
                "<text class=\"code-id\"\n" +
                "x=\"105\" y=\"280\">2</text>" +
                "<text class=\"mktime\"\n" +
                "x=\"105\" y=\"280\">black</text>" +
                "<text class=\"myChild\"\n" +
                "x=\"105\" y=\"280\"></text>" +
                "<text class=\"myFather\"\n" +
                "x=\"105\" y=\"280\"></text>" +
                "</g>";

            $("#code-logic-scene").append(element).html($("#code-logic-scene").html());

            //update intersection array
            intersectArrInit();
        }, 20);

        timeStampAll();
        intersectArrInit();
        previewGroupSelection();

        $('#push-code').click(function () {
            getDataArrayOfSvgInScene();
        });
    });

    var selectedElement;
    var currentX = 0;
    var currentY = 0;
    var currentMatrix = 0;
    var childMatrix = [];
    var svgScene = [], svgIntersectArr = [];
    var tmpTotalDx, tmpTotalDy;
    var tmpMatrixX, tmpMatrixY;

    /**
     * Selecting svg element function. Used to init selectedElement by svg <g> element.
     * @param evt
     */
    function selectElement(evt) {
        //On element click preparing clean array for selected element children
        childMatrix = [];
        //Taking svg <g> element
        selectedElement = evt.target.parentNode;

        //Tracking mouse coordinates
        currentX = evt.clientX;
        currentY = evt.clientY;
        //Preventing from error caused by clicking on non <g> element
        if(selectedElement.tagName === "g") {
            currentMatrix = selectedElement.getAttributeNS(null, "transform").slice(7, -1).split(' ');
        }
        if(selectedElement.tagName === "FORM" || selectedElement.tagName === "foreignObject")
            return;

        //Push selected element to back
        //Remove
        $(selectedElement).remove();
        //Append to html document
        $(selectedElement).appendTo("#code-logic-scene");
        //Update
        selectedElement = $("#code-logic-scene").children().last()[0];

        //Reordering child in html document
        reorderChildrenInDocument(selectedElement);

        //Saving children translate matrix in case of grouped elements conjunction
        var childrenData = getChildrenData(selectedElement);
        if(childrenData.length > 0 && childrenData[0] !== "") {
            for(i = 0; i < childrenData.length; i++) {
                var childM = getGelementByName(childrenData[i]).getAttributeNS(null, "transform").slice(7, -1).split(' ');
                childMatrix.push({
                    childmktime: getChildrenData(selectedElement)[i],
                    childM: childM,
                    childMatrixStartX: parseFloat(childM[4]),
                    childMatrixStartY: parseFloat(childM[5])
                });
            }
        }

        //Creating array of values from svg element transform translate attribute
        for(var i = 0; i < currentMatrix.length; i++) {
            currentMatrix[i] = parseFloat(currentMatrix[i]);
        }
        //Saving starting x and y coordinates for selected element, on case if element would be dragged over unjoinable element
        tmpMatrixX = currentMatrix[4];
        tmpMatrixY = currentMatrix[5];

        //Setting event listeners (attributes) to svg <g> element
        selectedElement.setAttributeNS(null, "onmousemove", "moveElement(evt)");
        selectedElement.setAttributeNS(null, "onmouseleave", "deselectElement(evt)");
        selectedElement.setAttributeNS(null, "onmouseup", "deselectElement(evt)");
    }
    /**
     * Function calling every time element is moved.
     * Changing svg <g> element position in scene and triggers functions to find intersections.
     * @param evt
     */
    function moveElement(evt) {
        var dx = evt.clientX - currentX;
        var dy = evt.clientY - currentY;
        currentMatrix[4] += dx;
        currentMatrix[5] += dy;

        selectedElement.setAttributeNS(null, "transform", "matrix(" + currentMatrix.join(' ') + ")");

        currentX = evt.clientX;
        currentY = evt.clientY;

        //updating intersection array
        intersectArrUpdate(selectedElement);
        //finding intersection
        findIntersection(selectedElement);

        //transform translate children of selected element
        for(var i = 0; i < childMatrix.length; i++) {
            var tmpMatrix = childMatrix[i].childM;
            var child = getGelementByName(childMatrix[i].childmktime);

            for (var j = 0; j < tmpMatrix.length; j++) {
                tmpMatrix[j] = parseFloat(tmpMatrix[j]);
            }
            tmpMatrix[4] += dx;
            tmpMatrix[5] += dy;
            child.setAttributeNS(null, "transform", "matrix(" + tmpMatrix.join(' ') + ")");

            //updating intersection array
            intersectArrUpdate(child);
        }
    }
    /**
     * Big function - a lot of responsibilities
     * @param evt
     */
    function deselectElement(evt) {
        if(selectedElement !== 0){
            selectedElement.removeAttributeNS(null, "onmousemove");
            selectedElement.removeAttributeNS(null, "onmouseleave");
            selectedElement.removeAttributeNS(null, "onmouseup");
            var childData;

            var svgArr = document.getElementById("code-logic-scene").children;
            for(var i = 0; i < svgArr.length; i++) {
                //Killing existing father of child and giving new father
                //Going through all svg <g> elements
                //and deleting SELECTED element NAME from every element child section
                if ((svgArr[i].getElementsByClassName("myChild")[0].textContent.indexOf(getmktime(selectedElement)) !== -1) &&
                    (tmpMatrixX !== currentMatrix[4] || tmpMatrixY !== currentMatrix[5])) {
                    console.log("Going to clean father's ** " + getmktime(svgArr[i]) + " ** children");
                    console.log(i);
                    childData = getChildrenData(svgArr[i]);
                    var cleanData = "";
                    for (var j = 0; j < childData.length; j++) {
                        if (childData[j] !== getmktime(selectedElement)) {
                            if (j > 0)
                                cleanData += ",";
                            cleanData += childData[j];
                        }
                        else
                            break;
                    }
                    console.log("child data: " + childData);
                    console.log("cleaned child data: " + cleanData);
                    svgArr[i].getElementsByClassName("myChild")[0].innerHTML = cleanData;
                    //svgArr[i].getElementsByClassName("myFather")[0].innerHTML = "none";
                    //console.log("My father: " + svgArr[i].getElementsByClassName("myFather")[0].textContent);
                }
            }
            for(i = 0; i < svgArr.length; i++){
                //Found intersection
                if((svgArr[i].firstElementChild.getAttribute("stroke") === "green") &&
                    svgArr[i].firstElementChild.getAttribute("stroke-dasharray") === "0") {

                    //Main father -> element that was with green border
                    var fathersName = getmktime(svgArr[i]);
                    //Main father -> svg <g> element
                    var father = svgArr[i];

                    //Check if father is already have kids if so -> prevent from joining
                    if(getChildrenData(father).length > 0 && getChildrenData(father)[0] !== ""){
                        moveSelectedElementBack();
                        break;
                    }

                    //Setting father value
                    //selectedElement.getElementsByClassName("myFather")[0].innerHTML = fathersName;

                    //Joining element to another by y axis
                    while (father.firstElementChild.getAttribute("stroke") === "green"){
                        currentMatrix[5] += 1;
                        tmpTotalDy += 1;
                        selectedElement.setAttributeNS(null, "transform", "matrix(" + currentMatrix.join(' ') + ")");

                        //updating intersection array
                        intersectArrUpdate(selectedElement);
                        //finding intersection
                        findIntersection(selectedElement);
                    }
                    //Aligning element by x axis
                    while(getElementXf(father) !== getElementXf(selectedElement)){
                        if(getElementXf(father) <= getElementXf(selectedElement)) {
                            currentMatrix[4] -= 1;
                            tmpTotalDx -= 1;
                        }
                        if(getElementXf(father) >= getElementXf(selectedElement)) {
                            currentMatrix[4] += 1;
                            tmpTotalDx += 1;
                        }
                        selectedElement.setAttributeNS(null, "transform", "matrix(" + currentMatrix.join(' ') + ")");

                        //updating intersection array
                        intersectArrUpdate(selectedElement);
                        //finding intersection
                        findIntersection(selectedElement);
                    }

                    //Say that selected element is child
                    childData = father.getElementsByClassName("myChild")[0].textContent;
                    if(childData.indexOf(getmktime(selectedElement)) === -1)
                        father.getElementsByClassName("myChild")[0].innerHTML = getmktime(selectedElement);
                    if(childData.indexOf(getmktime(selectedElement)) === -1 && childData.length > 0)
                        father.getElementsByClassName("myChild")[0].innerHTML = childData + "," + getmktime(selectedElement);

                    childData = getChildrenData(selectedElement);
                    
                    //Checking is SELECTED element have any children
                    if(childData.length > 0 && childData[0] !== ""){
                        for(j = 0; j < childData.length; j++) {
                            if (getChildrenData(father).indexOf(childData[j]) === -1 && childData.length > 0)
                                getGelementByName(fathersName).getElementsByClassName("myChild")[0].innerHTML =
                                    getChildrenData(father) + "," + childData[j];
                        }

                        //paimti visus vaikus prijungiamo objekto
                        childData = getChildrenData(selectedElement);
                        for(j = 0; j < childData.length; j++){
                            var childM = getGelementByName(childData[j]).getAttributeNS(null, "transform").slice(7, -1).split(' ');
                            for(k = 0; k < childM.length; k++) {
                                childM[k] = parseFloat(childM[k]);
                            }
                            childM[4] += tmpTotalDx;
                            childM[5] += tmpTotalDy;

                            getGelementByName(childData[j]).setAttributeNS(null, "transform", "matrix(" + childM.join(' ') + ")");

                            //updating intersection array
                            intersectArrUpdate(getGelementByName(childData[j]));
                        }
                    }

                    //Adding SELECTED element child name to main father of the element group
                    for (var l = 0; l < svgArr.length; l++){
                        childData = getChildrenData(svgArr[l]);
                        for(j = 0; j < childData.length; j++){
                            if(childData[j] === fathersName){
                                childData = svgArr[l].getElementsByClassName("myChild")[0].textContent;

                                if(childData.indexOf(getmktime(selectedElement)) === -1 && childData.length > 0) {
                                    console.log("Adding selected");
                                    svgArr[l].getElementsByClassName("myChild")[0].innerHTML = childData + "," + getmktime(selectedElement);

                                    var selectedElemChildData = getChildrenData(selectedElement);
                                    if(selectedElemChildData.length > 0 && selectedElemChildData[0] !== "") {
                                        for (k = 0; k < selectedElemChildData.length; k++) {
                                            console.log(selectedElemChildData[k]);
                                            childData = svgArr[l].getElementsByClassName("myChild")[0].textContent;
                                            svgArr[l].getElementsByClassName("myChild")[0].innerHTML = childData + "," + selectedElemChildData[k];

                                        }
                                    }
                                }
                                break;
                            }
                        }
                    }
                }

                //If element can not be joined
                if((svgArr[i].firstElementChild.getAttribute("stroke") === "green") &&
                    svgArr[i].firstElementChild.getAttribute("stroke-dasharray") !== "0")
                    moveSelectedElementBack();

                //Deleting element
                if((svgArr[i].firstElementChild.getAttribute("stroke") === "red") &&
                    svgArr[i].firstElementChild.getAttribute("stroke-dasharray") === "0") {
                    console.log("Going to delete");
                    deleteSvgElement(selectedElement);
                }
            }
        }
        selectedElement = 0;
        tmpTotalDx = 0;
        tmpTotalDy = 0;
    }
    /**
     * Reverting changes with selected element moving
     * Pushing element back to start point
     */
    function moveSelectedElementBack() {
        currentMatrix[4] = tmpMatrixX;
        currentMatrix[5] = tmpMatrixY;
        selectedElement.setAttributeNS(null, "transform", "matrix(" + currentMatrix.join(' ') + ")");
        //updating intersection array
        intersectArrUpdate(selectedElement);
        //finding intersection
        findIntersection(selectedElement);

        for (var i = 0; i < childMatrix.length; i++) {
            var tmpMatrix = childMatrix[i].childM;
            var child = getGelementByName(childMatrix[i].childmktime);

            for (var k = 0; k < tmpMatrix.length; k++) {
                tmpMatrix[k] = parseFloat(tmpMatrix[k]);
            }
            tmpMatrix[4] = childMatrix[i].childMatrixStartX;
            tmpMatrix[5] = childMatrix[i].childMatrixStartY;
            child.setAttributeNS(null, "transform", "matrix(" + tmpMatrix.join(' ') + ")");

            //updating intersection array
            intersectArrUpdate(child);
        }
    }
    /**
     * On group hover draw border for every element in group
     */
    function previewGroupSelection() { //TODO remove rect from if
        $('#code-logic-scene').on('mouseenter', 'g', function() {
            var hoverElement = $(this).children()[0];
            if(hoverElement !== undefined && (hoverElement.tagName === "path" || hoverElement.tagName === "rect")) {
                hoverElement.setAttribute("stroke", "blue");
                hoverElement.setAttribute("stroke-width", "3.5");

                var childData = getChildrenData(hoverElement.parentNode);
                if(childData.length > 0 && childData[0] !== "") {
                    for (var i = 0; i < childData.length; i++) {
                        getGelementByName(childData[i]).firstElementChild.setAttribute("stroke", "blue");
                        getGelementByName(childData[i]).firstElementChild.setAttribute("stroke-width", "3.5");
                    }
                }
            }
        }).on('mouseleave', 'g', function() {
            var hoverElement = $(this).children()[0];
            if(hoverElement !== undefined && (hoverElement.tagName === "path" || hoverElement.tagName === "rect")) {
                hoverElement.setAttribute("stroke", "black");
                hoverElement.setAttribute("stroke-width", "2");

                var childData = getChildrenData(hoverElement.parentNode);
                if(childData.length > 0 && childData[0] !== "") {
                    for (var i = 0; i < childData.length; i++) {
                        getGelementByName(childData[i]).firstElementChild.setAttribute("stroke", "black");
                        getGelementByName(childData[i]).firstElementChild.setAttribute("stroke-width", "2");
                    }
                }
            }
        }).on('mousedown', 'g', function() {
            var hoverElement = $(this).children()[0];
            if(hoverElement !== undefined && (hoverElement.tagName === "path" || hoverElement.tagName === "rect")) {

                var childData = getChildrenData(hoverElement.parentNode);
                if(childData.length > 0 && childData[0] !== "") {
                    for (var i = 0; i < childData.length; i++) {
                        getGelementByName(childData[i]).firstElementChild.setAttribute("opacity", "0.5");
                    }
                }
            }
        }).on('mouseup', 'g', function() {
            var hoverElement = $(this).children()[0];
            if (hoverElement !== undefined && (hoverElement.tagName === "path" || hoverElement.tagName === "rect")) {

                var childData = getChildrenData(hoverElement.parentNode);
                if(childData.length > 0 && childData[0] !== "") {
                    for (var i = 0; i < childData.length; i++) {
                        getGelementByName(childData[i]).firstElementChild.setAttribute("opacity", "1");
                    }
                }

            }
        });
    }
    /**
     * Reorders children in html document to prevent overlapping
     * @param element - svg <g>
     */
    function reorderChildrenInDocument(element) {
        var childData = getChildrenData(element);
        var tmp;
        if(childData.length > 0 && childData[0] !== "") {
            for (var i = 0; i < childData.length; i++) {
                //Push selected element to back
                tmp = getGelementByName(childData[i]);
                //Remove
                $(tmp).remove();
                //Append to html document
                $(tmp).appendTo("#code-logic-scene");
            }
        }
    }
    /**
     * Get selected element all children names.
     * @param element Svg <g> component(element)
     * @returns {Array} String array of given element children names (mktime)
     */
    function getChildrenData(element) {
        var children = element.getElementsByClassName("myChild");
        //[0] index, cause getElementsByClassName return an array of found "myChild" classes
        return children[0].textContent.split(",");
    }
    /**
     * Creating array of SORTED data by (x;y) of all <g> svg elements in scene
     * initializing - svgScene[]
     */
    function getDataArrayOfSvgInScene() {
        var svgArr = document.getElementById("code-logic-scene").children;
        svgScene = [];
        //Creating array of just svg elements data
        for(var i = 0; i < svgArr.length; i++){
            if(getmktime(svgArr[i]) !== "trashbin")
                svgScene.push({
                    mktime: getmktime(svgArr[i]),
                    codeID: getSvgCodeId(svgArr[i]),
                    value: getDataFromSvgForm(svgArr[i]),
                    children: getChildrenData(svgArr[i]),
                    x: getElementXf(svgArr[i]),
                    y: getElementYf(svgArr[i])
                })
        }

        //sorting array by x and y coordinates example (100; 40) > (120; 10)
        svgScene.sort(
            function(a, b) {
                return (parseFloat(a.y) - parseFloat(b.y)) && (parseFloat(a.x) - parseFloat(b.x));
            }
        );

        //console.log(cxray.sort((a, b) => a[1] - b[1] || a[0] - b[0]));

        console.log("SVG scene sorted");
        console.log(svgScene);



        //kaip pasakyti kad koda skaityti kaip grupe








    }
    /**
     * Deleting element from svg scene
     * @param element - svg <g>
     */
    function deleteSvgElement(element){
        //If element have children delete them also
        var childData = getChildrenData(element);

        //Deleting selected element
        $(element).remove();

        if(childData.length > 0 && childData[0] !== "")
            for(var i = 0; i < childData.length; i++)
                $(getGelementByName(childData[i])).remove();

        intersectArrInit();

        for(i = 0; i < svgIntersectArr.length; i++)
            if(svgIntersectArr[i].trashbin)
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("transform", "scale(1.0)");
    }
    /**
     * Getting data from <input> or <select> tag from svg element
     *  @param element - svg <g> element
     */
    function getDataFromSvgForm(element) {
        var data, e;
        if(element.getElementsByClassName("code-selection").length > 0) {
            e = element.getElementsByClassName("code-selection")[0];
            data = e.options[e.selectedIndex].value;
        }
        if(element.getElementsByClassName("code-input").length > 0) {
            e = element.getElementsByClassName("code-input")[0];
            data = e.value;
        }
        return data;
    }
    /**
     * Get data from svg <text> tag with class code id
     *  @param element - svg <g> element
     */
    function getSvgCodeId(element) {
        return element.getElementsByClassName("code-id")[0].textContent;
    }
    /**
     * Intersected array initialization, load all exiting svg elements data into array
     */
    function intersectArrInit(){
        svgIntersectArr = [];
        var svgArr = document.getElementById("code-logic-scene").children;
        for(var i = 0; i < svgArr.length; i++){
            svgIntersectArr.push({
                mktime: getmktime(svgArr[i]),
                xf: getSvgElementX(svgArr[i]),
                xt: Math.round(svgArr[i].getBBox().width + getSvgElementX(svgArr[i])),
                yf: getSvgElementY(svgArr[i]),
                yt: Math.round(svgArr[i].getBBox().height + getSvgElementY(svgArr[i])),
                joinable: svgArr[i].classList.contains('joinable'),
                nonjoinable: svgArr[i].classList.contains('nonjoinable'),
                trashbin: svgArr[i].classList.contains('trash-bin')
            });
        }
        console.log(svgIntersectArr);
    }
    /**
     * Updating intersection array with selected svg element
     *  @param element - svg <g> element
     */
    function intersectArrUpdate(element) {
        for(var i = 0; i < svgIntersectArr.length; i++){
            if(svgIntersectArr[i].mktime === getmktime(element)){
                svgIntersectArr[i].xf = getElementXf(element);
                svgIntersectArr[i].xt = getElementXt(element);
                svgIntersectArr[i].yf = getElementYf(element);
                svgIntersectArr[i].yt = getElementYt(element);
                return;
            }
        }
    }
    /**
     * Finding intersection
     *  @param element - svg <g> element
     */
    function findIntersection(element) {
        //taking top border center point coordinations
        var elementX = Math.round(getElementXf(element) + ((getElementXt(element) - getElementXf(element)) / 2));
        var elementY = getElementYf(element);

        //clear un-intersected svg elements
        for(var i = 0; i < svgIntersectArr.length; i++) {
            getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke", "black");
            getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-width", "2");
            getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-dasharray", "0");
            if(svgIntersectArr[i].trashbin)
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("transform", "scale(1.0)");
        }
        //Checking or taken center dot is in any svg <g> elements
        for(i = 0; i < svgIntersectArr.length; i++){
            if(svgIntersectArr[i].mktime !== getmktime(element)){
                for(var x = svgIntersectArr[i].xf; x < svgIntersectArr[i].xt; ++x){
                    for(var y = svgIntersectArr[i].yf; y < svgIntersectArr[i].yt; ++y){
                        if(x === elementX && y === elementY){
                            previewIntersection(i, element);
                            return;
                        }
                    }
                }
            }
        }
    }
    /**
     * Drawing border for intersected element
     *  @param elementIndex - is int, index that represent element in intersection array
     * intersection array is save all svg elements array, but just only with name and coordinates data
     */
    function previewIntersection(elementIndex) {
        for(var i = 0; i < svgIntersectArr.length; i++){
            if(i === elementIndex){
                //Drawing standart green border to preview intersection
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke", "green");
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-width", "4");

                //If element which is now intersected can not be joined draw dashed border
                var hasClass = selectedElement.classList.contains('joinable');
                if(!(hasClass === svgIntersectArr[i].joinable))
                    getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-dasharray", "5,5,5");

                hasClass = selectedElement.classList.contains('nonjoinable');
                if(!(hasClass === svgIntersectArr[i].nonjoinable))
                    getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-dasharray", "5,5,5");


                if(svgIntersectArr[i].trashbin) {
                    getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-dasharray", "0");
                    getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke", "red");
                    getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("transform", "scale(1.3)");
                }

            }
            else {
                //Other elements in array that are not intersected is displayed with standard black border
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke", "black");
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-width", "2");
                getGelementByName(svgIntersectArr[i].mktime).firstElementChild.setAttribute("stroke-dasharray", "0");
            }
        }
    }
    /**
     * Timestamps svg elements in scene
     */
    function timeStampAll() {
        var svgArr = document.getElementById("code-logic-scene").children;
        for(var i = 0; i < svgArr.length; i++){
            //svgArr[i].getElementsByClassName("mktime")[0].innerHTML = mktime() + i; //patestuoti galima su [+ i]
            //svgArr[i].getElementsByClassName("mktime")[0].innerHTML = i;
        }
    }
    /**
     * Simply generates unique id -> timestamp
     */
    function mktime(){
        var d = new Date();
        return d.getTime();
    }
    /**
     * Get svg <g> element from name(mktime)
     * @param value - mktime
     * @returns {Element} <g> svg element
     */
    function getGelementByName(value) {
        var svg = document.getElementById("code-logic-scene");
        var elements = svg.getElementsByClassName("mktime");
        for(var i = 0; i < elements.length; i++) {
            if (elements[i].textContent === value) {
                return elements[i].parentNode;
            }
        }
    }
    /**
     * Get svg <g> element id === name === mktime
     * @param element - svg <g> element
     * @returns {string} value of svg <g> element
     */
    function getmktime(element) {
        return element.getElementsByClassName("mktime")[0].textContent;
    }
    /**
     * Get (x from) coordinates of svg <g> element  -> smallest possible x coordinate
     * @param element
     * @returns {number} x coordinates
     */
    function getElementXf(element) {
        return getSvgElementX(element);
    }
    /**
     * Get (x to) coordinates of svg <g> element -> largest possible x coordinate
     * @param element
     * @returns {number} x coordinates
     */
    function getElementXt(element) {
        return Math.round(element.getBBox().width + getSvgElementX(element))
    }
    /**
     * Get (y from) coordinates of svg <g> element -> smallest possible y coordinate
     * @param element
     * @returns {number} y coordinates
     */
    function getElementYf(element) {
        return getSvgElementY(element);
    }
    /**
     * Get (y to) coordinates of svg <g> element -> largest possible y coordinate
     * @param element
     * @returns {number} y coordinates
     */
    function getElementYt(element){
        return Math.round(element.getBBox().height + getSvgElementY(element));
    }
    /**
     * Simple function to get svg <g> element real x coordinates
     * @param element - svg <g>
     * @returns {number} X coordinate
     */
    function getSvgElementX(element){
        if(element.tagName === "g") {
            var matrix = element.getAttributeNS(null, "transform").slice(7, -1).split(' ');
            for (var i = 0; i < matrix.length; i++) {
                matrix[i] = parseFloat(matrix[i]);
            }
            return Math.round(element.getBBox().x + matrix[4]);
        }
    }
    /**
     * Simple function to get svg <g> element real y coordinates
     * @param element - svg <g>
     * @returns {number} Y coordinate
     */
    function getSvgElementY(element){
        if(element.tagName === "g") {
            var matrix = element.getAttributeNS(null, "transform").slice(7, -1).split(' ');
            for (var i = 0; i < matrix.length; i++) {
                matrix[i] = parseFloat(matrix[i]);
            }
            return Math.round(element.getBBox().y + matrix[5]);
        }
    }
   </script>
</html>